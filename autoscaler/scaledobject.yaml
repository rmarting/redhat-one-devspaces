---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: keda-prometheus-sa
  namespace: openshift-devspaces
---
apiVersion: v1
kind: Secret
metadata:
  name: kedasa-token
  namespace: openshift-devspaces
  annotations:
    kubernetes.io/service-account.name: keda-prometheus-sa 
type: kubernetes.io/service-account-token
---
# apiVersion: rbac.authorization.k8s.io/v1
# kind: ClusterRole
# metadata:
#   name: keda-prometheus-reader
# rules:
# - apiGroups: [""]
#   resources: ["services"]
#   verbs: ["get"]
# - apiGroups: ["monitoring.coreos.com"]
#   resources: ["prometheuses"]
#   verbs: ["get"]
# - apiGroups: [""]
#   resources: ["pods/portforward"]
#   verbs: ["create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kedasa-cluster-monitoring-view
subjects:
  - kind: ServiceAccount
    name: keda-prometheus-sa
    namespace: openshift-devspaces
roleRef:
  kind: ClusterRole
  name: cluster-monitoring-view
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: keda-trigger-auth-prometheus
  namespace: openshift-devspaces
spec:
  secretTargetRef:
  - parameter: bearerToken
    name: kedasa-token
    key: token
  - parameter: ca
    name: kedasa-token
    key: ca.crt
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: my-inversed-scaled-app
  namespace: openshift-devspaces
spec:
  # Reference to the object which KEDA must scale
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: my-scaled-service # <--- IMPORTANT! Replace with the name of your Deployment  
  # Scale configuration
  minReplicaCount: 0  # Min replica
  maxReplicaCount: 2  # Max replica
  pollingInterval: 30 # Metrics checkpoint - 30 seconds  
  # Trigger based on Prometheus (external metrics)
  triggers:
  - type: prometheus
    metadata:
      # 1. Prometheus Endpoint
      serverAddress: https://prometheus-k8s.openshift-monitoring.svc.cluster.local:9091      
      # 2. Metric name for KEDA
      metricName: inversed_workspaces
      # 3. Query PromQL inverse: 
      query: '2-(count(kube_pod_labels{label_controller_devfile_io_creator!=""}) or on() vector(0))'      
      # 4. Threshold
      threshold: "1"      
      # 5. Cooldown: Time to wait before reducing the scale once the metric has decreased
      cooldownPeriod: "30"
      authModes: "bearer"
    authenticationRef:
      name: keda-trigger-auth-prometheus
      kind: TriggerAuthentication
    